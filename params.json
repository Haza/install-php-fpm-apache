{"name":"Install php-fpm and apache","tagline":"","body":"Le but de cette étape est d'avoir un environnement permettant l'utilisation de plusieurs versions de PHP en  parallèle (le tout avec Apache).\r\nThe goal here is to be able to run Apache/PHP with multiple PHP installed on the machine, letting you a way to choose which version you want to run.\r\n\r\nTo be do that, we need to compile our own PHP.\r\n\r\nFirst, be sure to grab all the dependencies\r\n```\r\napt-get install build-essential libxml2-dev autoconf2.13 libpng12-* zlib1g gawk bison flex ^libxml2-* mcrypt libmcrypt-dev perl libcurl4-gnutls-dev libicu-dev libxslt1-dev\r\n```\r\n\r\nWe also need the JPEG lib\r\n```\r\napt-get install libjpeg62-dev\r\n```\r\n\r\nAnd the OpenSSL lib.\r\n\r\n```\r\napt-get install libcurl4-openssl-dev\r\n```\r\n\r\nThen, we need  Apache and <a href=\"http://httpd.apache.org/docs/2.2/mod/worker.html\">Apache MPM Worker</a>\r\n```\r\napt-get install apache2 apache2-mpm-worker\r\n```\r\n\r\n\r\nWe also need Apache's mod_fastcgi\r\nIf you try to run\r\n```\r\napt-get install libapache2-mod-fastcgi\r\n```\r\nYou'll get an error\r\n```\r\nE: Package 'libapache2-mod-fastcgi' has no installation candidate\r\n```\r\nThis is perfectly normal since the fastcgi package is in the \"non-free\" repository of debian.\r\n\r\nWe need to add those one\r\n```\r\nvim /etc/apt/sources.list\r\n```\r\nAdd those 2 lines : \r\n```\r\ndeb http://ftp.fr.debian.org/debian/ wheezy non-free\r\ndeb-src http://ftp.fr.debian.org/debian/ wheezy non-free\r\n```\r\n\r\nSave, quit\r\n\r\nDon't forget to update !\r\n```\r\napt-get update\r\n```\r\n\r\nNow, you can try again : \r\n```\r\napt-get install libapache2-mod-fastcgi\r\n```\r\n\r\nThen you'll need also those libs\r\n```\r\napt-get install libreadline-dev libfreetype6-dev\r\n```\r\n\r\nIt should now be good for Apache, at least for now.\r\n\r\nNext, PHP !\r\nAs said before, we'll need to compile our PHP.\r\nSo, grab the sources : http://php.net/downloads.php\r\nWe'll start with version 5.5 (5.5.4 right now)\r\n\r\n\r\n```\r\ncd /opt\r\nmkdir src\r\ncd src\r\nwget http://fr2.php.net/get/php-5.5.4.tar.gz/from/this/mirror\r\nmv mirror php-5.5.4.tar.gz\r\ntar xvfz mirror php-5.5.4.tar.gz \r\ncd php-5.5.4\r\n```\r\n\r\nNext, configure ! \r\n```\r\n./configure \\\r\n--prefix=/opt/php5.5.4 \\\r\n--with-readline \\\r\n--enable-cli \\\r\n--with-mysql=mysqlnd \\\r\n--with-mysqli=mysqlnd \\\r\n--with-pdo-mysql=mysqlnd \\\r\n--with-gd \\\r\n--with-freetype-dir \\\r\n--with-jpeg-dir \\\r\n--with-png-dir \\\r\n--with-zlib-dir \\\r\n--enable-gd-native-ttf \\\r\n--with-curl \\\r\n--enable-bcmath \\\r\n--enable-mbstring \\\r\n--enable-exif \\\r\n--enable-pcntl \\\r\n--enable-soap \\\r\n--with-xsl \\\r\n--enable-zip \\\r\n--with-config-file-path=/opt/php5.5.4/conf \\\r\n--with-config-file-scan-dir=/opt/php5.5.4/conf.d \\\r\n--with-iconv-dir=/opt/local \\\r\n--enable-fpm \\\r\n--with-fpm-user=www-data \\\r\n--with-fpm-group=www-data\r\n```\r\nYou need to be carfeful with the paths (/opt/php5.5.4/xxx) right here. It is used to be able to say PHP when it should be installed and where the configuration files are looked for.\r\n\r\n(here, you can grab a little coffee)\r\n\r\nThen, the make ! \r\n\r\n```\r\nmake\r\n```\r\n\r\n(Here, you can grab a big coffee)\r\n\r\nThen, install it ! \r\n```\r\nmake install\r\n```\r\n\r\nJust check that everything is there. Just go :\r\n```\r\ncd /opt/php5.5.4/\r\n```\r\n\r\nYou should find : \r\n```\r\nls /opt/php5.5.4\r\nbin  etc  include  lib     php  sbin  var\r\n```\r\n\r\nNow, we need to make some changes in the php-fpm configuration file.\r\n\r\nThankfully, PHP have an example file we could use :\r\n```\r\ncp /opt/php5.5.4//etc/php-fpm.conf.default /opt/php5.5.4/etc/php-fpm.conf\r\n```\r\n\r\nEdit this file : \r\n```\r\nvim /opt/php5.5.4/etc/php-fpm.conf  \r\n```\r\n\r\nHere are the changes you need to do : \r\nIn [global], uncomment\r\n```\r\npid = run/php-fpm.pid\r\n```\r\n\r\nAnd in the \"Pool Definitions\", you'll find the line : \r\n```\r\nlisten = 127.0.0.1:9000\r\n```\r\nChange this one to : \r\n```\r\nlisten = /var/run/php-fpm-5.5.4.sock\r\n```\r\nThis will allow us not to \"plug\" PHP to an IP:PORT, but to an unix socket.\r\nSave and quit.\r\n\r\n\r\nWe'll also need a basic php.ini file. Once again, PHP have one (in the souces) : \r\n```\r\ncd /opt/php5.5.4\r\nmkdir conf\r\ncp /opt/src/php-5.5.4/php.ini-development /opt/php5.5.4/conf/ \r\n```\r\nWe'll also need a startup script.\r\n\r\n```\r\ncp /opt/src/php-5.5.4/sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm5.5.4\r\n```\r\nBe sure the script is executable\r\n```\r\nchmod +x  /etc/init.d/php-fpm5.5.4\r\n```\r\nNext, we'll go back to Apache configuration\r\n\r\nBe sure that the \"actions\" and \"fastcgi\" extensions are enable\r\n```\r\na2enmod actions fastcgi \r\n```\r\n\r\nNow, we need to change the mod_fastcgi configuration to fits our needs\r\n```\r\ncd /etc/apache2/mods-enabled/\r\nvim fastcgi.conf\r\n```\r\n\r\nThis file needs to be changes to that : \r\n```\r\n<IfModule mod_fastcgi.c>\r\n AddHandler fastcgi-script .fcgi\r\n FastCgiIpcDir /var/lib/apache2/fastcgi\r\n FastCgiConfig -autoUpdate -singleThreshold 100 -killInterval 300 -maxProcesses 10 -maxClassProcesses 1\r\n AddHandler php5-fcgi .php\r\n AddType application/x-httpd-php .php\r\n ScriptAlias /fastcgi/ /var/www/fastcgi/\r\n\r\n <Directory \"/var/www/fastcgi\">\r\n   Options +ExecCGI\r\n   SetHandler fastcgi-script\r\n   Order Deny,Allow\r\n   Allow from env=REDIRECT_STATUS\r\n </Directory>\r\n <Location \"/fastcgi/php5.fpm\">\r\n\r\n     Order Deny,Allow\r\n     Deny from all\r\n     Allow from env=REDIRECT_STATUS\r\n </Location>\r\n FastCgiExternalServer /var/www/fastcgi/php5.fpm -socket /var/run/php-fpm-5.5.4.sock\r\n Action php5-fcgi /fastcgi/php5.fpm\r\n\r\n</IfModule>\r\n```\r\n\r\nThe important part here is ```FastCgiExternalServer /var/www/fastcgi/php5.fpm -socket /var/run/php-fpm-5.5.4.sock```\r\nThe last part (```-socket /var/run/php-fpm-5.5.4.sock```) is the same that we have changed before in the \"/opt/php5.5.4/etc/php-fpm.conf\" file.\r\n \r\n\r\nAbout the ```/var/www/fastcgi/php5.fpm<```, the directory \"fastcgi\" needs to exist. It can be empty, but it really need to exist. So, let's create it :\r\n```\r\nmkdir /var/www/fastcgi/\r\n```\r\n\r\nEt voilà, let's test it now ! \r\n\r\nAdd a php file in /var/www\r\n```\r\nvim /var/www/index.php\r\n```\r\n\r\nWith just a simple phpinfo() in it\r\n```\r\n<?php phpinfo();\r\n```\r\n\r\n\r\nStart Apache and php-fpm\r\n```\r\n/etc/init.d/apache2 restart\r\n/etc/init.d/php-fpm5.5.4 restart  \r\n```\r\n\r\nNow, with your broswer, go check that everything works.\r\n\r\nhttp://<IP>/index.php\r\nYou should see \"PHP Version 5.5.4\"\r\n\r\nWe now have our Apache/PHP working. But what about adding a PHP 5.3 now ?\r\n\r\nCompile it !\r\n```\r\ncd /opt/src/\r\nwget http://fr2.php.net/get/php-5.3.27.tar.gz/from/this/mirror\r\nmv mirror php-5.3.27.tar.gz\r\ntar xvfz php-5.3.27.tar.gz \r\ncd php-5.3.27\r\n```\r\n\r\nDon't forget to change the paths \r\n```\r\n./configure \\\r\n--prefix=/opt/php5.3.27 \\\r\n--with-readline \\\r\n--enable-cli \\\r\n--with-mysql=mysqlnd \\\r\n--with-mysqli=mysqlnd \\\r\n--with-pdo-mysql=mysqlnd \\\r\n--with-gd \\\r\n--with-freetype-dir \\\r\n--with-jpeg-dir \\\r\n--with-png-dir \\\r\n--with-zlib-dir \\\r\n--enable-gd-native-ttf \\\r\n--with-curl \\\r\n--enable-bcmath \\\r\n--enable-mbstring \\\r\n--enable-exif \\\r\n--enable-pcntl \\\r\n--enable-soap \\\r\n--with-xsl \\\r\n--enable-zip \\\r\n--with-config-file-path=/opt/php5.3.27/conf \\\r\n--with-config-file-scan-dir=/opt/php5.3.27/conf.d \\\r\n--with-iconv-dir=/opt/local \\\r\n--enable-fpm \\\r\n--with-fpm-user=www-data \\\r\n--with-fpm-group=www-data\r\n```\r\n\r\n```\r\nmake\r\n```\r\n(coffee)\r\n```\r\nmake install\r\n```\r\n\r\n```\r\ncd /opt/php5.3.27/\r\ncp /opt/php5.3.27/etc/php-fpm.conf.default /opt/php5.3.27/etc/php-fpm.conf\r\nvim /opt/php5.3.27/etc/php-fpm.conf\r\n```\r\n\r\nAs before, change the values : \r\n```\r\npid = run/php-fpm.pid\r\n```\r\nAnd of course, change the socket (use an other one)\r\n```\r\n listen = /var/run/php-fpm-5.3.27.sock\r\n```\r\n\r\nphp.ini and startup script : \r\n```\r\ncd /opt/php5.3.27\r\nmkdir conf\r\ncp /opt/src/php-5.3.27/php.ini-development /opt/php5.3.27/conf/ \r\ncp /opt/src/php-5.3.27/sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm5.3.27\r\nchmod +x  /etc/init.d/php-fpm5.3.27\r\n```\r\n\r\nWe also need to make an other change in the fastcgi.conf file : \r\n```\r\nvim /etc/apache2/mods-enabled/fastcgi.conf\r\n```\r\n\r\nSee the line\r\n```\r\nFastCgiExternalServer /var/www/fastcgi/php5.fpm -socket /var/run/php-fpm-5.5.4.sock\r\n```\r\nAdd an other one, just below\r\n```\r\nFastCgiExternalServer /var/www/fastcgi/php5.3.fpm -socket /var/run/php-fpm-5.3.27.sock \r\n```\r\n\r\nWe should have : \r\n```\r\n<IfModule mod_fastcgi.c>\r\n AddHandler fastcgi-script .fcgi\r\n FastCgiIpcDir /var/lib/apache2/fastcgi\r\n FastCgiConfig -autoUpdate -singleThreshold 100 -killInterval 300 -maxProcesses 10 -maxClassProcesses 1\r\n AddHandler php5-fcgi .php\r\n AddType application/x-httpd-php .php\r\n ScriptAlias /fastcgi/ /var/www/fastcgi/\r\n\r\n <Directory \"/var/www/fastcgi\">\r\n   Options +ExecCGI\r\n   SetHandler fastcgi-script\r\n   Order Deny,Allow\r\n   Allow from env=REDIRECT_STATUS\r\n </Directory>\r\n <Location \"/fastcgi/php5.fpm\">\r\n\r\n     Order Deny,Allow\r\n     Deny from all\r\n     Allow from env=REDIRECT_STATUS\r\n </Location>\r\n FastCgiExternalServer /var/www/fastcgi/php5.fpm -socket /var/run/php-fpm-5.5.4.sock\r\n FastCgiExternalServer /var/www/fastcgi/php5.3.fpm -socket /var/run/php-fpm-5.3.27.sock\r\n Action php5-fcgi /fastcgi/php5.fpm\r\n</IfModule>\r\n```\r\n\r\nThat it !\r\nHow to choose which PHP version you want to use ?\r\nEasy, just go in your Apache Virtualhost, and change the \"Action php5-fcgi /fastcgi/php5.fpm\" to the right fastcgi server.\r\nExample with the basic virtualhost\r\n```\r\n  vim /etc/apache2/sites-enabled/000-default\r\n```\r\n\r\nBefore </VirtualHost>, add \r\n```\r\nAction php5-fcgi /fastcgi/php5.3.fpm\r\n```\r\n\r\nSo we have : \r\n```\r\n<VirtualHost *:80>\r\n        ServerAdmin webmaster@localhost\r\n\r\n        DocumentRoot /var/www\r\n        <Directory />\r\n                Options FollowSymLinks\r\n                AllowOverride None\r\n        </Directory>\r\n        <Directory /var/www/>\r\n                Options Indexes FollowSymLinks MultiViews\r\n                AllowOverride None\r\n                Order allow,deny\r\n                allow from all\r\n        </Directory>\r\n\r\n        ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/\r\n        <Directory \"/usr/lib/cgi-bin\">\r\n                AllowOverride None\r\n                Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch\r\n                Order allow,deny\r\n                Allow from all\r\n        </Directory>\r\n\r\n        ErrorLog ${APACHE_LOG_DIR}/error.log\r\n\r\n        # Possible values include: debug, info, notice, warn, error, crit,\r\n        # alert, emerg.\r\n        LogLevel warn\r\n\r\n        CustomLog ${APACHE_LOG_DIR}/access.log combined\r\n        Action php5-fcgi /fastcgi/php5.3.fpm\r\n\r\n</VirtualHost>\r\n```\r\nSave and quit.\r\n\r\nLaunch all you php-fpm and Apache\r\n\r\n```\r\n/etc/init.d/php-fpm5.5.4 restart \r\n/etc/init.d/php-fpm5.3.27 restart \r\n/etc/init.d/apache2 restart \r\n```\r\n\r\nNow, if you go on http://<IP>/index.php, you should see  \"PHP Version 5.3.27\"\r\n\r\nEt voilà !\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}